<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>64-bit Arm(R) (Aarch64) SME optimization - Ripple User Manual</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../css/variables-8adf115d.css">
        <link rel="stylesheet" href="../css/general-2459343d.css">
        <link rel="stylesheet" href="../css/chrome-ae938929.css">
        <link rel="stylesheet" href="../css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="../highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="../ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex-4e9cd9d1.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc-dad146e4.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Ripple User Manual</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="64-bit-armr-aarch64-sme-optimization"><a class="header" href="#64-bit-armr-aarch64-sme-optimization">64-bit Arm(R) (AArch64) SME Optimization</a></h1>
<p>Since the Arm(R)v9 architecture,
Arm ISAs include the Scalable Vector Extensions (SVE) and
the Scalable Matrix Extensions (SME).</p>
<p>SME includes native instructions to perform matrix operations
using a two-dimensional SIMD register.
This enables the optimization of matrix operations
including matrix multiplication (using the outer product algorithm),
convolutions, and transpositions.</p>
<p>Ripple allows us to write code run on a multi-dimensional block.
In two dimensions, that block is basically a matrix of SIMD processing elements.
This looks a lot like the SME engine.
Based on that observation, the AArch64 LLVM backend is able to recognize
two-dimensional patterns written in Ripple and render them as SME instructions.</p>
<p>We review these patterns in the next sections.</p>
<h2 id="matrix-multiplication-pattern-recognition-from-ripple_parallel-annotations"><a class="header" href="#matrix-multiplication-pattern-recognition-from-ripple_parallel-annotations">Matrix multiplication pattern recognition from ripple_parallel annotations</a></h2>
<p>Ripple enables users to write matrix multiplication in an OpenMP style
using the <code>ripple_parallel</code> and <code>ripple_parallel_full</code> loop annotations.
Both API operate similarly, with the key difference being that
<code>ripple_parallel_full</code> assumes only the full-vector loops
and does not handle leftover elements,
whereas <code>ripple_parallel</code> generates both the full-vector loop and the
epilogue to process any remaining elements.</p>
<p>To begin, user specifies a 32x32 block shape using the
<code>ripple_set_block_shape(SME_LANES, SME_SIZE, SME_SIZE)</code> API.
Then the <code>ripple_parallel</code> annotations are applied to two <code>for</code> loops along the
y and x dimensions.
This instructs the Ripple compiler to distribute the processing elements
across the y and x dimensions of 32x32 blocks.
This approach simplifies indexing into matrices A, B and C,
allowing them to be accessed using a flat, non-tiled pointer (e.g., <code>float *</code>).
For example, an element of matrix A can be accessed as <code>A[k * M + i]</code>,
where <code>i</code> is the y-coordinate of the processing element.</p>
<p>Since there is no full tile assumption,
Ripple AArch64 SME compiler generates SVE PSEL (predicate select) instructions
to handle partial tiles.</p>
<pre><code class="language-C">#include &lt;ripple.h&gt;
#define SME_LANES 0
#define SME_SIZE 32

__arm_locally_streaming __arm_new("za")
void matmul_arg(float *A, float *B, float *C, int M, int N, int K) {
  ripple_block_t sme_block =
    ripple_set_block_shape(SME_LANES, SME_SIZE, SME_SIZE);
  ripple_parallel(sme_block, 1);
  for (int i = 0; i &lt; M; i++) {
    ripple_parallel(sme_block, 0);
    for (int j = 0; j &lt; N; j++) {
      __builtin_assume(K &gt; 0);
      float tile = 0;
      for (int k = 0; k &lt; K; k++) {
        tile += A[k * M + i] * B[k * N + j];
      }
      C[i * N + j] = tile;
    }
  }
}
</code></pre>
<p>The generated assembly is complex,
so we focus on a segment corresponding to tile 4,
which includes predicate handling for both matrices A and B.
In this segment, four SVE <code>whilelt</code> instructions are used
to construct predicate registers for A and B.
These are followed by SVE <code>psel</code> instructions,
which generate new predicate registers needed for storing data.</p>
<pre><code class="language-asm">	...
	fmopa	za0.s, p0/m, p0/m, z17.s, z16.s
	fmopa	za1.s, p0/m, p0/m, z17.s, z19.s
	fmopa	za2.s, p0/m, p0/m, z18.s, z16.s
	fmopa	za3.s, p0/m, p0/m, z18.s, z19.s
	...
.LBB0_4520:                             // %store.preheader4
	...
	whilelt	p8.s, x10, x11
	whilelt	p1.s, x8, x11
	whilelt	p3.s, x8, x12
	whilelt	p2.s, x13, x12
	...
.LBB0_4521:                             // %store.body4
	mov	z0.b, p4/m, za0h.b[w12, 0]
	mov	z1.b, p4/m, za0h.b[w12, 1]
	mov	z2.b, p4/m, za0h.b[w12, 2]
	mov	z3.b, p4/m, za0h.b[w12, 3]
	psel	p5, p2, p8.s[w14, 0]
	psel	p6, p3, p8.s[w14, 0]
	psel	p7, p2, p1.s[w14, 0]
	psel	p0, p3, p1.s[w14, 0]
	...
	st1w	{ z0.s }, p5, [x8]
	st1w	{ z1.s }, p6, [x8, #1, mul vl]
	st1w	{ z2.s }, p7, [x9]
	st1w	{ z3.s }, p0, [x9, #1, mul vl]
	...
</code></pre>
<h2 id="matrix-multiplication-in-spmd-style"><a class="header" href="#matrix-multiplication-in-spmd-style">Matrix multiplication in SPMD style</a></h2>
<p>The SME pattern-matching also works on SPMD-style matrix multiplications.
To keep the code concise here, we assume that both M and N are divisible by 32,
the user first calls <code>ripple_set_block_shape</code>
to set a 2D block shape of 32x32 for the processing elements (SME_LANES).
In this example, we have also optimized the C matrix for stores from the SME
vector register, by tiling its data to the size of that register.</p>
<pre><code class="language-C">#include &lt;ripple.h&gt;
#include &lt;assert.h&gt;
#define SME_LANES 0
#define SME_SIZE 32

__arm_locally_streaming __arm_new("za")
void gen_matmul_tiled(float A[K][M], float B[K][N],
                      float C[M / SME_SIZE][N / SME_SIZE][SME_SIZE][SME_SIZE]) {
  assert (M % SME_SIZE == 0);
  assert (N % SME_SIZE == 0);
  ripple_block_t sme_block =
    ripple_set_block_shape(SME_LANES, SME_SIZE, SME_SIZE);
  size_t x = ripple_id(sme_block, 0);
  size_t y = ripple_id(sme_block, 1);
  for (int i = 0; i &lt; M / SME_SIZE; i++) {
    for (int j = 0; j &lt; N / SME_SIZE; j++) {
      float tile = 0;
      for (int k = 0; k &lt; K; k++) {
        tile += A[k][SME_SIZE * i + y] * B[k][SME_SIZE * j + x];
      }
      C[i][j][y][x] = tile;
    }
  }
}
</code></pre>
<p>Using the Ripple AArch64 SME compiler, SME floating-point outer product
and accumulate instructions (FMOPA) are generated,
along with the necessary load and store instructions to transfer data
between memory and the ZA matrix.
For floating-point data types,
the ZA matrix provides four tiles (ZA0 to ZA3) for computation.
The outer product operations are performed across all four tiles.
When storing results from the ZA matrix back to memory,
the data is accessed in byte format using ZA0 as the base index.
The contents of Z0 and Z1 are stored contiguously in memory, as are Z2 and Z3.</p>
<pre><code class="language-asm">    ...
    zero	{za}
.LBB0_5:                                // %for.body8
    ld1b	{ z0.b }, p0/z, [x0, x18]
    ld1b	{ z1.b }, p0/z, [x17, x18]
    ldr	z2, [x12, #1, mul vl]
    ldr	z3, [x4, #1, mul vl]
    ...
    fmopa	za0.s, p1/m, p1/m, z0.s, z1.s
    fmopa	za1.s, p1/m, p1/m, z0.s, z3.s
    fmopa	za2.s, p1/m, p1/m, z2.s, z1.s
    fmopa	za3.s, p1/m, p1/m, z2.s, z3.s
    b.ne	.LBB0_5
    ...
.LBB0_7:                                // %store.body
    mov	z0.b, p0/m, za0h.b[w12, 0]
    mov	z1.b, p0/m, za0h.b[w12, 1]
    mov	z2.b, p0/m, za0h.b[w12, 2]
    mov	z3.b, p0/m, za0h.b[w12, 3]
    st1b	{ z0.b }, p0, [x13, x18]
    st1b	{ z1.b }, p0, [x14, x18]
    st1b	{ z2.b }, p0, [x15, x18]
    st1b	{ z3.b }, p0, [x16, x18]
    ...
    b.ne	.LBB0_7
    ...
</code></pre>
<h2 id="tile-based-transpose-pattern-recognition"><a class="header" href="#tile-based-transpose-pattern-recognition">Tile-based transpose pattern recognition</a></h2>
<p>We also taught LLVM to recognize transposition
– another simple two-dimensional pattern coming out of Ripple code –
and express it in SME.</p>
<p>In the example below, the <code>transpose_tile</code> function performs
a tile-wise transpose of a matrix block.
This is achieved using the <code>ripple_shuffle</code> API,
where the <code>row_idx</code> and <code>offset</code> are swapped to perform a tile transpose.
The <code>transpose_ripple</code> function leverages this by looping over 32x32 tiles
and applying different row strides to the source and destination matrices.
This enables the correct reordering of elements during the transpose.
Specifically, the input matrix is indexed using row stride <code>k</code>,
whereas the output matrix is indexed using row stride <code>TILE_SIZE 32</code>.</p>
<pre><code class="language-C">#include &lt;ripple.h&gt;
#include &lt;assert.h&gt;
#define TILE_SIZE 32

static __attribute__((always_inline)) float transpose_tile(float *tile_addr,
                                                           size_t v) {
  auto transpose = [](size_t k, size_t block_size) -&gt; size_t {
    unsigned offset = k / TILE_SIZE;
    unsigned row_idx = k % TILE_SIZE;
    return row_idx * TILE_SIZE + offset;
  };
  return ripple_shuffle(tile_addr[v], transpose);
}

__arm_locally_streaming __arm_new("za")
void transpose_ripple(float *dest, float *src, unsigned m, unsigned k) {
  assert(m % TILE_SIZE == 0);
  assert(k % TILE_SIZE == 0);
  ripple_block_t sme_block =
    ripple_set_block_shape(0, TILE_SIZE, TILE_SIZE);
  size_t x = ripple_id(sme_block, 0);
  size_t y = ripple_id(sme_block, 1);
  for (int i = 0; i &lt; m; i += TILE_SIZE)
    for (int j = 0; j &lt; k; j += TILE_SIZE) {
      dest[y * TILE_SIZE + x] = transpose_tile(&amp;src[i * k + j], y * k + x);
      dest += TILE_SIZE * TILE_SIZE;
    }
}
</code></pre>
<p>The compiler code generation for transpose operation is still a
work in progress.
The assembly shown here is generated based on
the expected compiler-transformed IR,
utilizing all four tiles for horizontal loads and vertical stores.</p>
<pre><code class="language-asm">.LBB0_8:                                // %load.loop
	...
	ld1w	{za0h.s[w15, 0]}, p0/z, [x6]
	ld1w	{za1h.s[w15, 0]}, p0/z, [x19]
	ld1w	{za2h.s[w15, 0]}, p0/z, [x20]
	ld1w	{za3h.s[w15, 0]}, p0/z, [x21]
	...
	b.ne	.LBB0_8
	...
.LBB0_10:                               // %store.loop
	...
	st1w	{za0v.s[w15, 0]}, p0, [x6]
	st1w	{za1v.s[w15, 0]}, p0, [x19]
	st1w	{za2v.s[w15, 0]}, p0, [x20]
	st1w	{za3v.s[w15, 0]}, p0, [x19]
	...
	b.ne	.LBB0_10
</code></pre>
<h1 id="limitations"><a class="header" href="#limitations">Limitations</a></h1>
<p>The work presented in this section is based on pattern matching,
which enables a gentle-slope increase of the set of optimizable codes.
In this section,
we denote some of the known limitations to the current implementation.</p>
<h2 id="declare-the-function-to-use-sme-so-called-streaming-mode"><a class="header" href="#declare-the-function-to-use-sme-so-called-streaming-mode">Declare the function to use SME (so-called “streaming mode”)</a></h2>
<p>Currently, in order to activate the SME code generation from matrix
multiplication codes in a given function, we need to annotate the function
with</p>
<pre><code class="language-C">__arm_locally_streaming __arm_new("za")
</code></pre>
<p>as illustrated in the above examples.</p>
<h2 id="enforce-zero-initialized-muladd-accumulator"><a class="header" href="#enforce-zero-initialized-muladd-accumulator">Enforce zero-initialized muladd accumulator</a></h2>
<p>Unfortunately, there is no single SVE or SME instruction available
to initialize the entire ZA matrix with non-zero values.
As a result, the compiler must generate a loop structure
to load non-zero values from memory into the ZA matrix tiles, slice by slice.
Since the Ripple AArch64 SME compiler already emits a loop structure
to store the final results from the multiply-accumulate operation back to memory,
it’s more efficient to reuse this loop and
perform the necessary operations outside the ZA matrix.</p>
<p>The recommended approach is to initialize the accumulator (e.g., <code>temp</code>) to zero,
then add the result back to output matrix using:
<code>C[it * IT + i][jt * JT + j] += temp</code>.
This avoids initializing values from <code>C[it * IT + i][jt * JT + j]</code>
into the ZA matrix.
The operation <code>+=</code> is performed outside the ZA matrix,
which aligns better with the current compiler design.</p>
<pre><code class="language-C">  ...
  if (k == 0)
    C[it * IT + i][jt * JT + j] = 0;
  float temp = 0;
  for (int k = 0; k &lt; KT; ++k) {
    temp += A[kt * KT + k][it * IT + i] * B[kt * KT + k][jt * JT + j];
  }
  C[it * IT + i][jt * JT + j] += temp;
  ...
</code></pre>
<p>Currently, the support for moving operations outside of the ZA matrix
for non-zero initial values is not yet implemented.
The Ripple AArch64 SME compiler temporarily reject such cases.</p>
<p>Below is an example of initializing non-zero values from
<code>C[it * IT + i][jt * JT + j]</code> into accumulator <code>temp</code>.
Such usage is not recommended and will be rejected by the
Ripple AArch64 SME compiler.</p>
<pre><code class="language-C">  ...
  float temp = (kt == 0) ? 0 : C[it * IT + i][jt * JT + j];
  for (int k = 0; k &lt; KT; ++k) {
    temp += A[kt * KT + k][it * IT + i] * B[kt * KT + k][jt * JT + j];
  }
  C[it * IT + i][jt * JT + j] = temp;
  ...
</code></pre>
<h2 id="limitations-on-using-constant-matrix-sizes-in-compilation"><a class="header" href="#limitations-on-using-constant-matrix-sizes-in-compilation">Limitations on using constant matrix sizes in compilation</a></h2>
<ul>
<li>
<p><strong>Ripple_parallel annotated matrix multiplication</strong>: Constant matrix sizes are
not supported. Use parameterized sizes instead.</p>
</li>
<li>
<p><strong>SPMD-style matrix multiplication</strong>: Small constant matrix sizes are not
supported. Ensure <strong>M</strong> and <strong>N</strong> are greater than 32, and <strong>K</strong> is greater
than 1.</p>
</li>
</ul>
<h1 id="some-useful-clang-command-line-flags"><a class="header" href="#some-useful-clang-command-line-flags">Some useful clang command-line flags</a></h1>
<p>The SME codegen presented in this section is available for Armv9.2-A.
You can specify this to clang using the following flags:</p>
<pre><code class="language-bash">-march=armv9.2-a+sme --target=aarch64-linux-gnu
</code></pre>
<p>We need to also specify the targeted streaming vector length
using the following flag:</p>
<pre><code class="language-bash">-msve-streaming-vector-bits=512
</code></pre>
<p>Unrolling some of the loops can obfuscate the pattern matched by the SME
optimization. To avoid this, use</p>
<pre><code class="language-bash">-fno-unroll-loops
</code></pre>
<p>… and of course you need to enable Ripple.</p>
<pre><code class="language-bash">-fenable-ripple
</code></pre>
<p>In some compiler settings, auto-vectorization can interfere with Ripple.
If that happens, auto-vectorization can be turned off using</p>
<pre><code class="language-bash">-fno-vectorize
</code></pre>
<p>At last, SME pattern matching and optimization are enabled at O2 and above.
You will need:</p>
<pre><code class="language-bash">-O2
</code></pre>
<hr>
<p>Arm is a registered trademark of Arm Limited (or its subsidiaries).</p>
<hr>
<p><em>Copyright (c) 2024-2025 Qualcomm Innovation Center, Inc. All rights reserved.
SPDX-License-Identifier: BSD-3-Clause-Clear</em></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../opt-guide/coalescing.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="../getting-started.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../opt-guide/coalescing.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="../getting-started.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr-ef4e11c1.min.js"></script>
        <script src="../mark-09e88c2c.min.js"></script>
        <script src="../searcher-c2a407aa.js"></script>

        <script src="../clipboard-1626706a.min.js"></script>
        <script src="../highlight-abc7f01d.js"></script>
        <script src="../book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
